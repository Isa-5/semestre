/*
 * conversion_ADC.c
 *
 *  Created on: Oct 31, 2020
 *      Author: isae_
 */

///////////////////////////////////////////////////////////////////////////////////////////////////
//                                      Includes Section
///////////////////////////////////////////////////////////////////////////////////////////////////

#include "MKL25Z4.h"
#include "conversion_ADC.h"


Mapeo_valores const Tabla_Termopar[]=
{
		{16,16},{17,17},{18,18},{19,19},
		{20,20},{21,21},{22,22},{23,23},{24,24},{25,25},{26,26},{27,27},{28,28},{29,29},
		{30,30},{32,31},{33,32},{34,33},{35,34},{36,35},{37,36},{38,37},{39,38},{40,39},
		{41,40},{42,41},{43,42},{44,43},{45,44},{46,45},{47,46},{48,47},{50,48},{51,49},
		{52,50},{53,51},{54,52},{55,53},{56,54},{57,55},{58,56},{59,57},{60,58},{61,59},
		{62,60},{63,61},{64,62},{65,63},{67,64},{68,65},{69,66},{70,67},{71,68},{72,69},
		{73,70},{74,71},{75,72},{76,73},{77,74},{78,75},{79,76},{80,77},{82,78},{83,79},
		{84,80},{85,81},{86,82},{87,83},{88,84},{89,85},{90,86},{91,87},{92,88},{93,89},
		{94,90},{96,91},{97,92},{98,93},{99,94},{100,95},{101,96},{102,97},{103,98},{104,99},
		{105,100},{106,101},{107,102},{109,103},{110,104},{111,105},{112,106},{113,107},{114,108},{115,109},
		{116,110},{117,111},{118,112},{119,113},{121,114},{122,115},{123,116},{124,117},{125,118},{126,119},
		{127,120},{128,121},{129,122},{130,123},{132,124},{133,125},{134,126},{135,127},{136,128},{137,129},
		{138,130},{139,131},{140,132},{141,133},{143,134},{144,135},{145,136},{146,137},{147,138},{148,139},
		{149,140},{150,141},{151,142},{152,143},{154,144},{155,145},{156,146},{157,147},{158,148},{159,149},
		{160,150},{161,151},{162,152},{163,153},{165,154},{166,155},{167,156},{168,157},{169,158},{170,159},
		{171,160},{172,161},{173,162},{175,163},{176,164},{177,165},{178,166},{179,167},{180,168},{181,169},
		{182,170},{183,171},{184,172},{186,173},{187,174},{188,175},{189,176},{190,177},{191,178},{192,179},
		{193,180}
};

///////////////////////////////////////////////////////////////////////////////////////////////////
//                                      Function Section
///////////////////////////////////////////////////////////////////////////////////////////////////

void medidor_init (void)
{
	Init_ADC();
}

uint8_t conversion (void)
{
	uint16_t resultado_muestra=0;
	uint32_t suma_resultado=0;
	uint8_t conteo_muestra=0;
	uint8_t resultado_grados=0;
#ifdef TERMOPAR
	uint8_t resultado_encontrado=0;
#endif 
	
	for (conteo_muestra=0;conteo_muestra<5;conteo_muestra++)
	{
		resultado_muestra=Medidor_input();
		suma_resultado+=resultado_muestra;
	}
	
	suma_resultado=suma_resultado/5;//promedio, 
	
#ifdef TERMOPAR
	for (conteo_muestra=0;(conteo_muestra<(size_Table-1))&&(resultado_encontrado==0);conteo_muestra++)
	{
		if((suma_resultado>=Tabla_Termopar[conteo_muestra].valor_crudo) && (suma_resultado<Tabla_Termopar[conteo_muestra+1].valor_crudo))
		{
			resultado_grados=Tabla_Termopar[conteo_muestra].valor_grados;
			resultado_encontrado=1;
		}

	}
	if (resultado_encontrado==0)//Error no encontro suma_resultado==valor_crudo
	{
		resultado_grados=0xFF;
		//Mandar UART? si sucede muchas veces
	}

#else
	//LM35
	resultado_grados=(suma_resultado/3);//3 mV lo mínimo que me puede dar = 1, 10mV=3/3=1°C
	
#endif
	
return resultado_grados;	
	
	
	
}
